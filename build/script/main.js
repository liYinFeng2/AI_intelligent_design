function UploadImgMes(){var e=$(".resize-image")[0].src,t=[];$(".setjob-content .title").each(function(){t.push($(this).val())});var o=[];$(".sel-size .active").each(function(){o.push($(this).attr("size"))});for(var i=0;i<o.length;i++)o[i]=o[i].split(",");$.ajax({url:"http://192.168.224.23/v1/aidesign",type:"post",dataType:"json",data:JSON.stringify({img:e,banner_para:{titles_list:t,size_list:o,logo_type:"",matting_rect_list:matting_rect_list,slogan_rect_list:slogan_rect_list,font_type_list:"",font_size_list:"",title_color_list:"",adder_sreen_list:"",resize_k_list:resize_k,txt_sp_list:""}}),success:function(e){0==resize_k.length&&$(".resize-image").css({width:$(".resize-image").width()/e.resize_k_list[0],height:$(".resize-image").height()/e.resize_k_list[0]}),slogan_rect_top=e.slogan_rect_list[0].top,slogan_rect_right=e.slogan_rect_list[0].right,slogan_rect_bottom=e.slogan_rect_list[0].bottom,slogan_rect_left=e.slogan_rect_list[0].left,matting_rect_left=e.matting_rect_list[0].left,matting_rect_top=e.matting_rect_list[0].top,matting_rect_bottom=e.matting_rect_list[0].bottom,matting_rect_right=e.matting_rect_list[0].right,resize_k.length=0,resize_k.push(e.resize_k_list[0]);var t;if(e.base64_image_list)for(var i=0;i<e.base64_image_list.length;i++)t=e.base64_image_list[0].replace("/+/g","2B%");$(".resize-container img").css("opacity",.4),$(".overlay").css({"background-image":"url(data:image/jpeg;base64,"+t+")",width:o[0][0],height:o[0][1],top:e.matting_rect_list[0].top,left:e.matting_rect_list[0].left}),$(".overlay").show()},error:function(e){console.log(e)}})}function move(e){var t={x:e.pageX,y:e.pageY};slogan_rect_list=[];var o=slogan_rect_top+(t.y-xy.y),i=slogan_rect_left+(t.x-xy.x),n=o+(slogan_rect_bottom-slogan_rect_top),s=i+(slogan_rect_right-slogan_rect_left);slogan_rect_list.push({top:o,left:i,bottom:n,right:s}),console.log(t.y-xy.y),console.log(matting_rect_top),console.log(matting_rect_left),UploadImgMes(slogan_rect_list,resize_k)}function stop(){$(document).unbind({mousemove:move,mouseup:stop})}var img_base64_url,matting_rect_top,matting_rect_left,matting_rect_bottom,matting_rect_right,slogan_rect_top,slogan_rect_right,slogan_rect_bottom,slogan_rect_left,resize_k=[],slogan_rect_list=[],matting_rect_list=[];$(document).ready(function(){$(".setjob-content").css("height",0),$(".setjob-content").css("height",$(document).height()-50)}),$(".setjob-content .sel-size ul li").on("click",function(){$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active")});var upload_ops={init:function(){this.eventBind()},eventBind:function(){var e=this;$("#upload").change(function(){$("#uploadInf").html("");var t=new FileReader;t.onload=function(t){e.compress(this.result)},t.readAsDataURL(this.files[0])})},compress:function(e){var t=new Image;t.onload=function(){var e=document.createElement("canvas"),o=e.getContext("2d");t.width>1e3&&(t.height*=1e3/t.width,t.width=1e3),e.width=t.width,e.height=t.height,o.clearRect(0,0,e.width,e.height),o.drawImage(t,0,0,t.width,t.height);var i=e.toDataURL("image/jpeg",1);$(".resize-image").attr("src",i)},t.src=e}};$(document).ready(function(){upload_ops.init()});var resizeableImage=function(e){var t,o=new Image,e=$(e).get(0),i={},n=document.createElement("canvas");o.crossOrigin="*",init=function(){o.src=e.src,$(e).wrap('<div class="resize-container"></div>').before('<span class="resize-handle resize-handle-nw"></span>').before('<span class="resize-handle resize-handle-ne"></span>').after('<span class="resize-handle resize-handle-se"></span>').after('<span class="resize-handle resize-handle-sw"></span>'),t=$(e).parent(".resize-container"),t.on("mousedown touchstart",".resize-handle",startResize),t.on("mousedown touchstart","img",startMoving),$(".js-crop").on("click",crop)},startResize=function(e){e.preventDefault(),e.stopPropagation(),saveEventState(e),$(document).on("mousemove touchmove",resizing),$(document).on("mouseup touchend",endResize)},endResize=function(e){e.preventDefault(),$(document).off("mouseup touchend",endResize),$(document).off("mousemove touchmove",resizing)},saveEventState=function(e){i.container_width=t.width(),i.container_height=t.height(),i.container_left=t.offset().left,i.container_top=t.offset().top,i.mouse_x=(e.clientX||e.pageX||e.originalEvent.touches[0].clientX)+$(window).scrollLeft(),i.mouse_y=(e.clientY||e.pageY||e.originalEvent.touches[0].clientY)+$(window).scrollTop(),void 0!==e.originalEvent.touches&&(i.touches=[],$.each(e.originalEvent.touches,function(e,t){i.touches[e]={},i.touches[e].clientX=0+t.clientX,i.touches[e].clientY=0+t.clientY})),i.evnt=e},resizing=function(e){var n,s,a,r,l={};t.offset();l.x=(e.clientX||e.pageX||e.originalEvent.touches[0].clientX)+$(window).scrollLeft(),l.y=(e.clientY||e.pageY||e.originalEvent.touches[0].clientY)+$(window).scrollTop(),$(i.evnt.target).hasClass("resize-handle-se")?(n=l.x-i.container_left,s=l.y-i.container_top,a=i.container_left,r=i.container_top):$(i.evnt.target).hasClass("resize-handle-sw")?(n=i.container_width-(l.x-i.container_left),s=l.y-i.container_top,a=l.x,r=i.container_top):$(i.evnt.target).hasClass("resize-handle-nw")?(n=i.container_width-(l.x-i.container_left),s=i.container_height-(l.y-i.container_top),a=l.x,r=l.y,e.shiftKey&&(r=l.y-(n/o.width*o.height-s))):$(i.evnt.target).hasClass("resize-handle-ne")&&(n=l.x-i.container_left,s=i.container_height-(l.y-i.container_top),a=i.container_left,r=l.y,e.shiftKey&&(r=l.y-(n/o.width*o.height-s))),e.shiftKey&&(s=n/o.width*o.height),n>60&&s>60&&n<1e3&&s<1e3&&(resizeImage(n,s),t.offset({left:a,top:r}))},resizeImage=function(t,i){n.width=t,n.height=i,n.getContext("2d").drawImage(o,0,0,t,i),$(e).attr("src",n.toDataURL("image/png"))},startMoving=function(e){e.preventDefault(),e.stopPropagation(),saveEventState(e),$(document).on("mousemove touchmove",moving),$(document).on("mouseup touchend",endMoving)},endMoving=function(e){e.preventDefault(),$(document).off("mouseup touchend",endMoving),$(document).off("mousemove touchmove",moving)},moving=function(e){var o,n={};e.preventDefault(),e.stopPropagation(),o=e.originalEvent.touches,n.x=(e.clientX||e.pageX||o[0].clientX)+$(window).scrollLeft();var s=n.x-(i.mouse_x-i.container_left),a=$(".resize-image").width()-($(".overlay").offset().left-$(".resize-image").offset().left)-400;s>=$(".overlay").offset().left&&(s=$(".overlay").offset().left),s<=$(".resize-image").offset().left-a&&(s=$(".resize-image").offset().left-a),matting_rect_list=[];var r=$(".overlay").offset().top-$(".resize-image").offset().top,l=$(".overlay").offset().left-$(".resize-image").offset().left,c=r+(matting_rect_bottom-matting_rect_top),g=r+(matting_rect_right-matting_rect_left);if(matting_rect_list.push({top:r,left:l,bottom:c,right:g}),console.log(resize_k),UploadImgMes(),t.offset({left:s}),$(".overlay").css("background-position-x",$(".resize-image").offset().left-$(".overlay").offset().left),i.touches&&i.touches.length>1&&o.length>1){var _=i.container_width,f=i.container_height,h=i.touches[0].clientX-i.touches[1].clientX;h*=h;var m=Math.sqrt(h);h=e.originalEvent.touches[0].clientX-o[1].clientX,h*=h;var u=Math.sqrt(h),p=u/m;console.log(n.x),_*=p,f*=p,resizeImage(_,f)}},crop=function(){var o,i=$(".overlay").offset().left-t.offset().left,n=$(".overlay").offset().top-t.offset().top,s=$(".overlay").width(),a=$(".overlay").height();o=document.createElement("canvas"),o.width=s,o.height=a,o.getContext("2d").drawImage(e,i,n,s,a,0,0,s,a),o.getContext("2d").fillStyle="white",o.getContext("2d").globalAlpha=.2,img_base64_url=o.toDataURL("image/png"),UploadImgMes()},$(".overlay").css("background-position-x",$(".resize-image").offset().left-$(".overlay").offset().left),init()};resizeableImage($(".resize-image")),$(".btn-crop").click(function(){UploadImgMes(slogan_rect_list,resize_k)}),$(".upload-file").on("change","input[type='file']",function(){var e=$(this).val();if(-1==e.indexOf("jpg")&&-1==e.indexOf("png"))return alert("您上传文件类型有误!"),!1;var t=e.split("\\"),o=t[t.length-1];$(".filename").val(o)});var xy={};$(".resize-image").mousedown(function(e){xy.x=e.pageX,xy.y=e.pageY;var t=e.pageX-$(".resize-image").offset().left-matting_rect_left,o=e.pageY-$(".resize-image").offset().top-matting_rect_top;if(t>=slogan_rect_left&&t<=slogan_rect_right&&o>=slogan_rect_top&&o<=slogan_rect_bottom)return $(document).bind({mousemove:move,mouseup:stop}),!1});